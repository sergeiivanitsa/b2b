name: Deploy prod

on:
  workflow_run:
    workflows:
      - Product API unit tests
    types:
      - completed

concurrency:
  group: prod-deploy
  cancel-in-progress: false

jobs:
  deploy:
    if: >-
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.head_branch == 'main'
      }}
    runs-on: ubuntu-latest
    steps:
      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PROD_SSH_KEY }}

      - name: Add known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.RU_HOST }}" >> ~/.ssh/known_hosts
          ssh-keyscan -H "${{ secrets.US_HOST }}" >> ~/.ssh/known_hosts

      - name: Checkout deploy commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: services/web_ui/package-lock.json

      - name: Build web_ui static bundle
        run: |
          npm ci --prefix services/web_ui
          npm run build --prefix services/web_ui
          tar -C services/web_ui/dist -czf /tmp/web_ui-dist.tgz .

      - name: Deploy RU
        run: |
          ssh -o StrictHostKeyChecking=yes "${{ secrets.RU_USER }}@${{ secrets.RU_HOST }}" <<'EOF'
          set -euo pipefail
          cd /opt/b2b
          git fetch origin
          git checkout main
          git reset --hard origin/main

          docker compose -f docker-compose.product.yml --env-file .env.product up -d --build

          # health retry ~60s (12*5s)
          ok=0
          for i in $(seq 1 12); do
            if curl -fsS http://127.0.0.1:8000/health >/dev/null; then
              echo "RU health OK"
              ok=1
              break
            fi
            echo "RU health not ready ($i/12), waiting..."
            sleep 5
          done

          if [ "$ok" -ne 1 ]; then
            echo "RU health FAILED — docker ps:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || true
            echo "RU logs (last 200):"
            docker logs --tail 200 b2b-product_api-1 || true
            exit 1
          fi
          EOF

      - name: Deploy US
        run: |
          ssh -o StrictHostKeyChecking=yes "${{ secrets.US_USER }}@${{ secrets.US_HOST }}" <<'EOF'
          set -euo pipefail
          cd /opt/b2b
          git fetch origin
          git checkout main
          git reset --hard origin/main

          cp -f deploy/us/compose/docker-compose.gateway.yml docker-compose.gateway.yml
          docker compose -f docker-compose.gateway.yml --env-file .env.gateway up -d --build

          # health retry ~60s (12*5s)
          ok=0
          for i in $(seq 1 12); do
            if curl -fsS http://127.0.0.1:8001/health >/dev/null; then
              echo "US health OK"
              ok=1
              break
            fi
            echo "US health not ready ($i/12), waiting..."
            sleep 5
          done

          if [ "$ok" -ne 1 ]; then
            echo "US health FAILED — docker ps:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || true
            echo "US logs (last 200):"
            docker logs --tail 200 b2b-gateway_api-1 || true
            exit 1
          fi
          EOF

      - name: Deploy web_ui static on RU
        run: |
          scp -o StrictHostKeyChecking=yes /tmp/web_ui-dist.tgz "${{ secrets.RU_USER }}@${{ secrets.RU_HOST }}:/tmp/web_ui-dist.tgz"
          ssh -o StrictHostKeyChecking=yes "${{ secrets.RU_USER }}@${{ secrets.RU_HOST }}" <<'EOF'
          set -euo pipefail
          WEB_UI_DIST_DIR="/opt/b2b/services/web_ui/dist"

          mkdir -p "$WEB_UI_DIST_DIR"
          find "$WEB_UI_DIST_DIR" -mindepth 1 -maxdepth 1 -exec rm -rf {} +
          tar -xzf /tmp/web_ui-dist.tgz -C "$WEB_UI_DIST_DIR"
          rm -f /tmp/web_ui-dist.tgz

          if command -v sudo >/dev/null 2>&1; then
            sudo nginx -t
            sudo systemctl reload nginx
          else
            nginx -t
            systemctl reload nginx
          fi

          curl -fsS --resolve pork.su:443:127.0.0.1 https://pork.su/ >/dev/null

          whoami_code="$(curl -s -o /dev/null -w "%{http_code}" --resolve pork.su:443:127.0.0.1 https://pork.su/api/internal/whoami || true)"
          if [ "$whoami_code" != "401" ] && [ "$whoami_code" != "200" ]; then
            echo "Unexpected /api/internal/whoami status: $whoami_code"
            exit 1
          fi
          EOF
